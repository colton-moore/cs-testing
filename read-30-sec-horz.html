<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timer Chip</title>
  <style>
    :root{
      /* === EASY COLOR KNOBS === */
      --accent:#B31E2D;        /* dark red */
      --accent-light:#FCE6D8;  /* light orange */

      /* System */
      --chip-border:#E6E6EA;
      --chip-shadow:0 6px 16px rgba(16,24,40,.08);
      --text:#2B2B2B; --muted:#8C8C94; --digit-bg:#F7F7FA;

      /* Will be set by JS to lock chip/controls width */
      --chip-w:auto;
    }

    html,body{height:100%;margin:0;background:transparent;font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";color:var(--text)}
    .wrap{position:relative;width:100%;height:100%;min-height:80px;}

    /* === TRAY: pins to top-right and arranges items right-to-left === */
    .tray{position:absolute;top:8px;right:8px;display:flex;flex-direction:row-reverse;align-items:flex-start;gap:10px;z-index:10}

    /* === Chip & time pill === */
    .chip-col{display:flex;flex-direction:column;align-items:flex-end;gap:8px}

    .chip{box-sizing:border-box;display:flex;align-items:center;justify-content:center;gap:.6rem;padding:.45rem .75rem;border:1px solid var(--chip-border);border-radius:999px;background:#fff;box-shadow:var(--chip-shadow);cursor:pointer;user-select:none;width:var(--chip-w)}
    .chip:active{transform:translateY(1px)}
    .chip .icon-wrap{display:grid;place-items:center}
    .chip img{width:24px;height:24px;display:block}
    .chip .pill{display:inline-flex;align-items:center;font-variant-numeric:tabular-nums;letter-spacing:.6px;padding:.2rem .7rem;border-radius:14px;background:#fff;border:1.5px solid var(--accent);color:var(--accent);font-weight:800}

    /* Controls under the chip (smaller) — centered and same width as chip */
    .controls{box-sizing:border-box;display:none;align-items:center;justify-content:center;gap:.45rem;width:var(--chip-w)}
    .tray.open .controls{display:flex}
    .btn{display:inline-grid;place-items:center;border:none;border-radius:999px;background:var(--accent);color:#fff;min-width:34px;height:34px;padding:0 .55rem;cursor:pointer}
    .btn svg{width:14px;height:14px}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:var(--accent-light);color:var(--accent)}
    .btn.text{background:#fff;color:var(--accent);font-weight:700;border:1.5px solid var(--accent);min-width:auto;height:34px;padding:0 .6rem}

    /* Panel to the LEFT of the chip */
    .panel{display:none;border:1px solid var(--chip-border);border-radius:16px;background:#fff;box-shadow:0 20px 40px rgba(16,24,40,.14);padding:12px 14px 14px 14px;transform-origin:top right;animation:pop .18s ease;max-width:fit-content}
    .tray.open .panel{display:block}
    @keyframes pop{from{transform:scale(.97);opacity:0}to{transform:scale(1);opacity:1}}

    .panel-body{display:grid;grid-template-columns:auto 1fr;gap:14px;align-items:center}
    .meta{display:flex;flex-direction:column;gap:2px;color:#6A6A72}
    .meta .label{font-size:1rem;line-height:1.1}
    .meta .sub{font-size:.9rem;line-height:1}

    .lcd{display:flex;align-items:center}
    .lcd .screen{font-variant-numeric:tabular-nums;letter-spacing:2px;font-size:3rem;line-height:1;background:var(--digit-bg);border-radius:12px;padding:.5rem .85rem;border:1px solid #EDEDF2;box-shadow:inset 0 -2px 0 rgba(0,0,0,.03)}

    .vh{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <!--
      QUICK CUSTOMIZATION GUIDE
      1) JS: DEFAULT_MINUTES (or use ?min=1 / ?sec=60)
      2) JS: ICON_URL (or ?icon=<url>)
      3) CSS: --accent / --accent-light (or ?accent=#hex&accentLight=#hex)
    -->

    <!-- Tray holds the chip column (right) and the panel (left) -->
    <div class="tray" id="tray">
      <!-- Chip + controls column (on the RIGHT) -->
      <div class="chip-col">
        <button class="chip" id="chip" aria-expanded="false" aria-controls="timer-panel">
          <span class="icon-wrap" aria-hidden="true">
            <img id="chip-icon" alt="" />
          </span>
          <span class="pill"><span class="vh" id="chip-label">Timer:</span><span id="chip-time">02:00</span></span>
        </button>
        <div class="controls" id="controls">
          <button class="btn" id="play" aria-label="Pause timer" title="Pause">
            <svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M6 5h5v14H6zM13 5h5v14h-5z"/></svg>
          </button>
          <button class="btn text" id="add1" title="Add 1 minute">+1</button>
          <button class="btn secondary" id="reset" title="Reset">
            <!-- Use currentColor so the icon is dark red on light-orange bg -->
            <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 6V3L8 7l4 4V8a4 4 0 1 1-4 4H6a6 6 0 1 0 6-6Z"/></svg>
          </button>
        </div>
      </div>

      <!-- Panel (on the LEFT) -->
      <section class="panel" id="timer-panel" aria-hidden="true" role="group" aria-label="timer">
        <div class="panel-body">
          <div class="meta">
            <div class="label" id="panel-label">Read</div>
            <div class="sub" id="panel-sub">30 seconds</div>
          </div>
          <div class="lcd"><div class="screen" id="screen">02:00</div></div>
        </div>
      </section>
    </div>
  </div>

  <script>
    (function(){
      const qs=new URLSearchParams(location.search);

      /* CONFIG */
      const DEFAULT_MINUTES = .5; // change to 1 or 3 (or use ?min=1 / ?sec=60)
      const ICON_URL = 'https://s3.amazonaws.com/media-p.slid.es/uploads/2912448/images/12449075/MS-Read-Timer-v1.svg'; // or ?icon=...
      const accentURL = qs.get('accent');
      const accentLightURL = qs.get('accentLight');
      if(accentURL) document.documentElement.style.setProperty('--accent', accentURL);
      if(accentLightURL) document.documentElement.style.setProperty('--accent-light', accentLightURL);

      const secondsFromURL = qs.get('sec') ? parseInt(qs.get('sec'),10) : (qs.get('min') ? Math.round(parseFloat(qs.get('min'))*60) : NaN);
      const secondsDefault = Number.isFinite(secondsFromURL) && secondsFromURL>0 ? secondsFromURL : DEFAULT_MINUTES*60;
      const iconOverride = qs.get('icon');
      const label = qs.get('label') || 'Discuss';

      // Elements
      const tray=document.getElementById('tray');
      const chip=document.getElementById('chip');
      const controls=document.getElementById('controls');
      const panel=document.getElementById('timer-panel');
      const screen=document.getElementById('screen');
      const play=document.getElementById('play');
      const reset=document.getElementById('reset');
      const add1=document.getElementById('add1');
      const chipTime=document.getElementById('chip-time');
      const chipIcon=document.getElementById('chip-icon');
      const panelLabel=document.getElementById('panel-label');
      const panelSub=document.getElementById('panel-sub');

      // Icon + labels
      const ICON = iconOverride || ICON_URL;
      chipIcon.src = ICON;
      panelLabel.textContent = label;
      panelSub.textContent = `${Math.floor(secondsDefault/60)} minute${secondsDefault>=120?'s':''}`;

      // Lock in the chip width ONCE (at initial size), and keep it constant open/closed
      function lockChipWidth(){
        // measure after layout paints
        requestAnimationFrame(()=>{
          const w = chip.offsetWidth; // "few versions ago" size
          if(w){
            document.documentElement.style.setProperty('--chip-w', w + 'px');
          }
        });
      }
      lockChipWidth();

      // Timer state
      let remaining = secondsDefault, ticking=null, targetAt=null;
      const fmt = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(Math.floor(s%60)).padStart(2,'0')}`;
      const render = ()=>{ const t=fmt(remaining); screen.textContent=t; chipTime.textContent=t; document.title=t+' – Timer'; };
      render();

      const openPanel = ()=>{ tray.classList.add('open'); panel.setAttribute('aria-hidden','false'); chip.setAttribute('aria-expanded','true'); };
      const closePanel = ()=>{ tray.classList.remove('open'); panel.setAttribute('aria-hidden','true'); chip.setAttribute('aria-expanded','false'); };

      function beep(){ try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.type='sine';o.frequency.value=880;o.connect(g);g.connect(ctx.destination);g.gain.setValueAtTime(0.0001,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.3,ctx.currentTime+0.01);o.start();o.stop(ctx.currentTime+0.25);}catch(e){} }

      function start(){ if(ticking) return; if(!targetAt) targetAt=Date.now()+remaining*1000; play.innerHTML='<svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M6 5h5v14H6zM13 5h5v14h-5z"/></svg>'; ticking=setInterval(()=>{ const now=Date.now(); remaining=Math.max(0, Math.ceil((targetAt-now)/1000)); render(); if(remaining<=0){ stop(); beep(); } },250); }
      function stop(){ if(ticking){ clearInterval(ticking); ticking=null; } play.innerHTML='<svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7L8 5Z"/></svg>'; }
      function hardReset(){ stop(); remaining=secondsDefault; targetAt=null; render(); }

      // +1 minute
      add1.addEventListener('click', ()=>{ if(!targetAt){ remaining+=60; render(); } else { targetAt+=60000; remaining=Math.max(0, Math.ceil((targetAt-Date.now())/1000)); render(); } if(remaining<=0){ targetAt=Date.now()+60000; remaining=60; render(); start(); } });

      // Toggle
      chip.addEventListener('click', ()=>{ const isOpen = tray.classList.contains('open'); if(isOpen){ closePanel(); } else { openPanel(); if(!ticking) start(); } });
      play.addEventListener('click', ()=> ticking?stop():start());
      reset.addEventListener('click', hardReset);

      // URL flags
      if(qs.get('open')==='1'){ openPanel(); }
      if(qs.get('auto')==='1'){ openPanel(); start(); }
    })();
  </script>
</body>
</html>
